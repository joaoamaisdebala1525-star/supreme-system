-- Criador: JOAOTTRJK V1 BETA 

local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

-- Criar ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESP_GUI_JOAOTTRJK"
screenGui.Parent = playerGui

-- Frame principal
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 260, 0, 170)
frame.Position = UDim2.new(0, 20, 0, 200)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.Active = true
frame.Draggable = true
frame.Parent = screenGui

-- Label Criador
local label = Instance.new("TextLabel")
label.Text = "Criador: JOAOTTRJK V1 VERSÃO BETA"
label.Size = UDim2.new(1, -30, 0, 30)
label.Position = UDim2.new(0, 0, 0, 0)
label.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
label.TextColor3 = Color3.new(1, 1, 1)
label.Parent = frame

-- Botão fechar
local closeBtn = Instance.new("TextButton")
closeBtn.Text = "X"
closeBtn.Size = UDim2.new(0, 30, 0, 30)
closeBtn.Position = UDim2.new(1, -30, 0, 0)
closeBtn.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
closeBtn.TextColor3 = Color3.new(1, 1, 1)
closeBtn.Parent = frame

-- Botão ESP normal
local espBtn = Instance.new("TextButton")
espBtn.Text = "Ativar ESP"
espBtn.Size = UDim2.new(1, 0, 0, 50)
espBtn.Position = UDim2.new(0, 0, 0, 40)
espBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
espBtn.TextColor3 = Color3.new(1, 1, 1)
espBtn.Parent = frame

-- Botão ESP linha branca + tracers
local espLinhaBtn = Instance.new("TextButton")
espLinhaBtn.Text = "Ativar ESP Linha + Tracers"
espLinhaBtn.Size = UDim2.new(1, 0, 0, 50)
espLinhaBtn.Position = UDim2.new(0, 0, 0, 95)
espLinhaBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
espLinhaBtn.TextColor3 = Color3.new(1, 1, 1)
espLinhaBtn.Parent = frame

-- Botão reabrir GUI
local reopenBtn = Instance.new("ImageButton")
reopenBtn.Size = UDim2.new(0, 50, 0, 50)
reopenBtn.Position = UDim2.new(0, 20, 0, 200)
reopenBtn.BackgroundTransparency = 1
reopenBtn.Image = "rbxassetid://6031094670" -- ícone olho
reopenBtn.Visible = false
reopenBtn.Parent = screenGui

local espAtivo = false
local espLinhaAtivo = false

-- Tabelas para armazenar caixas de linhas e tracers
local espLinhaBoxes = {}
local tracers = {}

-- Função ESP normal Highlight
local function criarESP(player)
    if player.Character and not player.Character:FindFirstChild("Highlight") then
        local highlight = Instance.new("Highlight")
        highlight.Name = "Highlight"
        highlight.FillColor = Color3.fromRGB(0, 255, 0)
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.Parent = player.Character
    end
end

local function removerESP(player)
    if player.Character and player.Character:FindFirstChild("Highlight") then
        player.Character.Highlight:Destroy()
    end
end

-- Função para criar caixa com linhas brancas (4 frames) para contorno
local function criarCaixaLinha(player)
    local char = player.Character
    if not char then return end
    if espLinhaBoxes[player] then return end

    local box = {}

    local function criarLinha()
        local linha = Instance.new("Frame")
        linha.BackgroundColor3 = Color3.fromRGB(255, 255, 255) -- branco
        linha.BorderSizePixel = 0
        linha.ZIndex = 10
        linha.Parent = screenGui
        return linha
    end

    box.top = criarLinha()
    box.bottom = criarLinha()
    box.left = criarLinha()
    box.right = criarLinha()

    espLinhaBoxes[player] = box
end

local function removerCaixaLinha(player)
    local box = espLinhaBoxes[player]
    if box then
        for _, linha in pairs(box) do
            if linha and linha.Parent then
                linha:Destroy()
            end
        end
        espLinhaBoxes[player] = nil
    end
end

-- Função criar tracer (linha fina branca)
local function criarTracer(player)
    if tracers[player] then return end

    local line = Instance.new("Frame")
    line.Name = "Tracer"
    line.BackgroundColor3 = Color3.fromRGB(255, 255, 255) -- branco
    line.BorderSizePixel = 0
    line.AnchorPoint = Vector2.new(0.5, 0)
    line.Size = UDim2.new(0, 2, 0, 0)
    line.Position = UDim2.new(0.5, 0, 1, 0)
    line.ZIndex = 10
    line.Parent = screenGui

    tracers[player] = line
end

local function removerTracer(player)
    if tracers[player] then
        tracers[player]:Destroy()
        tracers[player] = nil
    end
end

-- Atualiza posição e tamanho da caixa e tracers toda frame
local function atualizarESP_Linha()
    for player, box in pairs(espLinhaBoxes) do
        local char = player.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            local rootPart = char.HumanoidRootPart
            local rootPos = rootPart.Position
            local rootSize = rootPart.Size

            -- 8 cantos da caixa 3D do rootPart
            local corners = {
                Vector3.new(rootPos.X - rootSize.X/2, rootPos.Y + rootSize.Y/2, rootPos.Z - rootSize.Z/2),
                Vector3.new(rootPos.X + rootSize.X/2, rootPos.Y + rootSize.Y/2, rootPos.Z - rootSize.Z/2),
                Vector3.new(rootPos.X - rootSize.X/2, rootPos.Y - rootSize.Y/2, rootPos.Z - rootSize.Z/2),
                Vector3.new(rootPos.X + rootSize.X/2, rootPos.Y - rootSize.Y/2, rootPos.Z - rootSize.Z/2),
                Vector3.new(rootPos.X - rootSize.X/2, rootPos.Y + rootSize.Y/2, rootPos.Z + rootSize.Z/2),
                Vector3.new(rootPos.X + rootSize.X/2, rootPos.Y + rootSize.Y/2, rootPos.Z + rootSize.Z/2),
                Vector3.new(rootPos.X - rootSize.X/2, rootPos.Y - rootSize.Y/2, rootPos.Z + rootSize.Z/2),
                Vector3.new(rootPos.X + rootSize.X/2, rootPos.Y - rootSize.Y/2, rootPos.Z + rootSize.Z/2),
            }

            local screenPoints = {}
            local visible = false
            for i, corner in ipairs(corners) do
                local screenPos, onScreen = Camera:WorldToViewportPoint(corner)
                screenPoints[i] = {pos = Vector2.new(screenPos.X, screenPos.Y), onScreen = onScreen}
                if onScreen then visible = true end
            end

            if visible then
                -- Retângulo mínimo que engloba pontos visíveis
                local minX = math.huge
                local maxX = -math.huge
                local minY = math.huge
                local maxY = -math.huge

                for _, point in pairs(screenPoints) do
                    if point.onScreen then
                        minX = math.min(minX, point.pos.X)
                        maxX = math.max(maxX, point.pos.X)
                        minY = math.min(minY, point.pos.Y)
                        maxY = math.max(maxY, point.pos.Y)
                    end
                end

                local thickness = 1 -- espessura linha branca

                -- Top
                box.top.Position = UDim2.new(0, minX, 0, minY)
                box.top.Size = UDim2.new(0, maxX - minX, 0, thickness)
                box.top.Visible = true

                -- Bottom
                box.bottom.Position = UDim2.new(0, minX, 0, maxY)
                box.bottom.Size = UDim2.new(0, maxX - minX, 0, thickness)
                box.bottom.Visible = true

                -- Left
                box.left.Position = UDim2.new(0, minX, 0, minY)
                box.left.Size = UDim2.new(0, thickness, 0, maxY - minY)
                box.left.Visible = true

                -- Right
                box.right.Position = UDim2.new(0, maxX, 0, minY)
                box.right.Size = UDim2.new(0, thickness, 0, maxY - minY)
                box.right.Visible = true
            else
                box.top.Visible = false
                box.bottom.Visible = false
                box.left.Visible = false
                box.right.Visible = false
            end
        else
            box.top.Visible = false
            box.bottom.Visible = false
            box.left.Visible = false
            box.right.Visible = false
        end
    end

    -- Atualizar tracers
    for player, line in pairs(tracers) do
        local char = player.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            local rootPos = char.HumanoidRootPart.Position
            local screenPos, onScreen = Camera:WorldToViewportPoint(rootPos)
            if onScreen then
                local baseX = Camera.ViewportSize.X / 2
                local baseY = Camera.ViewportSize.Y
                local dx = screenPos.X - baseX
                local dy = screenPos.Y - baseY
                local distance = math.sqrt(dx*dx + dy*dy)
                local angle = math.atan2(dy, dx)

                line.Position = UDim2.new(0, baseX, 0, baseY)
                line.Rotation = math.deg(angle) + 90
                line.Size = UDim2.new(0, 2, 0, distance)
                line.Visible = true
            else
                line.Visible = false
            end
        else
            line.Visible = false
        end
    end
end

-- Atualizar ESP para todos jogadores
local function atualizarESP()
    for _, p in pairs(game.Players:GetPlayers()) do
        if p ~= player then
            if espAtivo then
                criarESP(p)
                removerCaixaLinha(p)
                removerTracer(p)
            elseif espLinhaAtivo then
                criarCaixaLinha(p)
                criarTracer(p)
                removerESP(p)
            else
                removerESP(p)
                removerCaixaLinha(p)
                removerTracer(p)
            end
        end
    end
end

-- Botões
espBtn.MouseButton1Click:Connect(function()
    espAtivo = not espAtivo
    espBtn.Text = espAtivo and "Desativar ESP" or "Ativar ESP"
    espBtn.BackgroundColor3 = espAtivo and Color3.fromRGB(170, 0, 0) or Color3.fromRGB(0, 170, 0)

    if espAtivo and espLinhaAtivo then
        espLinhaAtivo = false
        espLinhaBtn.Text = "Ativar ESP Linha + Tracers"
        espLinhaBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    end

    atualizarESP()
end)

espLinhaBtn.MouseButton1Click:Connect(function()
    espLinhaAtivo = not espLinhaAtivo
    espLinhaBtn.Text = espLinhaAtivo and "Desativar ESP Linha + Tracers" or "Ativar ESP Linha + Tracers"
    espLinhaBtn.BackgroundColor3 = espLinhaAtivo and Color3.fromRGB(170, 0, 0) or Color3.fromRGB(0, 170, 0)

    if espLinhaAtivo and espAtivo then
        espAtivo = false
        espBtn.Text = "Ativar ESP"
        espBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    end

    atualizarESP()
end)

-- Jogador entrou
game.Players.PlayerAdded:Connect(function(p)
    p.CharacterAdded:Connect(function(char)
        if espAtivo then
            criarESP(p)
        elseif espLinhaAtivo then
            criarCaixaLinha(p)
            criarTracer(p)
        end
    end)
end)

-- Botão fechar GUI
closeBtn.MouseButton1Click:Connect(function()
    frame.Visible = false
    reopenBtn.Visible = true
end)

-- Botão reabrir GUI
reopenBtn.MouseButton1Click:Connect(function()
    frame.Visible = true
    reopenBtn.Visible = false
end)

-- Atualiza todo frame
RunService.RenderStepped:Connect(function()
    if espLinhaAtivo then
        atualizarESP_Linha()
    end
end)
